<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Quest Beat Saber Mod Checker</title>

<style>
/* Global reset and dark theme setup */
* {margin:0; padding:0; box-sizing:border-box;}

body {
  font-family: system-ui, -apple-system, sans-serif;
  background: linear-gradient(135deg, #0f0f0f, #1a1a1a);
  color: #e0e0e0;
  min-height: 100vh;
}

/* --- Header Section (Identical to Main Page) --- */
header {
  padding: 1.5rem 2rem; 
  text-align: center;
  background: #141414;
  position: sticky;
  top: 0;
  z-index: 100;
  display: flex;
  justify-content: space-between; 
  align-items: center;
}

h1 {
  font-size: 2.5rem;
  background: linear-gradient(135deg, #667eea, #764ba2);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  flex-shrink: 0;
}

.header-links {
  display: flex;
  gap: 1rem; 
  flex-shrink: 0;
}


.header-btn {
  display: flex;
  align-items: center;
  gap: 0.5rem;
  padding: 0.5rem 1rem;
  font-size: 0.85rem;
  background: #24292e; 
  border-radius: 8px;
  color: white;
  border: 1px solid rgba(255, 255, 255, 0.1);
  transition: background 0.2s;
  cursor: pointer;
  white-space: nowrap;
}

.header-btn:hover {
  background: #33383d;
}

/* --- Main Content Layout --- */
main {
  max-width: 1400px;
  margin: auto;
  padding: 2rem 1rem;
}

/* --- Top Controls (Search, Dropdown, and Action Buttons in one row) --- */
.top-controls {
  display: flex;
  gap: 1rem;
  max-width: 1200px; /* Wider to accommodate all buttons in a row */
  margin: 0 auto 2rem;
  align-items: stretch;
  flex-wrap: wrap;
}

.search-container {
  flex: 2; /* Search gets more space */
  min-width: 250px;
}

/* Custom Select Wrapper shared space with buttons */
.version-select-container {
  flex: 1.5;
  min-width: 250px;
}

/* Input and Dropdown trigger heights standardized to 50px */
input {
  width: 100%;
  padding: 1rem;
  border-radius: 12px;
  background: #1e1e1e;
  border: 2px solid rgba(102,126,234,0.3);
  color: white;
  font-size: 1rem;
  outline: none;
  height: 50px; 
}

/* Standardized Action Button (Deselect/Select Mods) */
.action-btn {
  padding: 0 1.5rem;
  border-radius: 12px;
  border: 1px solid #444;
  font-weight: 500;
  cursor: pointer;
  color: white;
  background: #2a2a2a;
  transition: transform 0.2s, background 0.2s;
  font-size: 0.9rem;
  display: flex;
  align-items: center;
  justify-content: center;
  height: 50px;
  white-space: nowrap;
}

.action-btn:hover {
  background: #333;
  border-color: #666;
}

.action-btn:active {
  transform: scale(0.96);
}

/* --- Dropdown Specific Styling --- */
.custom-select-wrapper {
  position: relative;
  user-select: none;
  height: 50px;
}

.dropdown-trigger {
  background: #1e1e1e;
  border: 2px solid rgba(102,126,234,0.3);
  display: flex;
  align-items: center;
  justify-content: space-between;
  width: 100%;
  height: 100%;
  padding: 0 1rem;
  border-radius: 12px;
  cursor: pointer;
  color: #aaa;
}

.dropdown-trigger.active {
  border-color: #764ba2;
  border-bottom-left-radius: 0;
  border-bottom-right-radius: 0;
}

.arrow {
  border: solid #667eea;
  border-width: 0 2px 2px 0;
  display: inline-block;
  padding: 4px;
  transform: rotate(45deg);
  transition: transform 0.3s;
}

.dropdown-trigger.active .arrow {
  transform: rotate(-135deg);
}

.custom-options {
  position: absolute;
  top: 100%;
  left: 0;
  right: 0;
  background: #1e1e1e;
  border: 2px solid rgba(102,126,234,0.3);
  border-top: none;
  border-radius: 0 0 12px 12px;
  z-index: 50;
  max-height: 300px;
  overflow-y: auto;
  opacity: 0;
  visibility: hidden;
  transform: translateY(-10px);
  transition: all 0.3s;
}

.custom-select-wrapper.open .custom-options {
  opacity: 1;
  visibility: visible;
  transform: translateY(0);
}

.custom-option {
  padding: 0.8rem 1rem;
  cursor: pointer;
  transition: background 0.2s;
  display: flex;
  justify-content: space-between;
}

.custom-option:hover { background: rgba(102,126,234,0.1); }
.custom-option.selected { color: #fff; background: rgba(102,126,234,0.2); }
.custom-option.disabled { opacity: 0.3; cursor: not-allowed; }

/* --- Table Styling --- */
.table-wrapper {
  overflow-x: auto;
  border-radius: 16px;
  position: relative;
  background: rgba(30,30,30,1);
  box-shadow: 0 4px 12px rgba(0,0,0,0.4);
}

.table-wrapper::before {
  content: "";
  position: absolute;
  inset: 0;
  padding: 2px;
  border-radius: 16px;
  background: linear-gradient(135deg,#667eea,#764ba2,#f093fb,#4facfe,#667eea);
  background-size: 400% 400%;
  animation: gradientFlow 8s linear infinite;
  z-index: -1;
  -webkit-mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
  -webkit-mask-composite: xor;
  mask-composite: exclude;
}

@keyframes gradientFlow {
  0% {background-position: 0% 50%;}
  50% {background-position: 100% 50%;}
  100% {background-position: 0% 50%;}
}

.compat-grid { width: 100%; border-collapse: collapse; }
.compat-grid th, .compat-grid td { padding: 1rem; text-align: center; border-bottom: 1px solid rgba(255,255,255,0.05); }
.compat-grid th:first-child, .compat-grid td:first-child { text-align: left; padding-left: 2rem; width: 40%; }
.compat-grid thead th { background: rgba(102,126,234,0.05); color: #fff; font-size: 0.8rem; text-transform: uppercase; }

.status-cell { font-size: 1.2rem; }
.compatible { color: #4ade80; text-shadow: 0 0 10px rgba(74, 222, 128, 0.3); }
.incompatible { color: #ef4444; opacity: 0.3; }

@media (max-width: 1024px) {
  .top-controls { flex-direction: column; }
  header { flex-direction: column; gap: 1rem; }
}
</style>
</head>
<body>

<header>
  <h1>Quest Beat Saber Mod Checker</h1>
  <div class="header-links">
    <a id="projectRepoLink" href="https://github.com/FatalMistake02/quest-bs-mod-checker" target="_blank" rel="noopener noreferrer" style="text-decoration:none;">
      <button class="header-btn">
        <svg viewBox="0 0 16 16" width="16" height="16" fill="currentColor"><path d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2.0-.21.15-.46.55-.38C13.71 14.53 16 11.54 16 8c0-4.42-3.58-8-8-8z"/></svg>
        Project Repo
      </button>
    </a>
    <a id="dataSourceLink" href="https://github.com/QuestPackageManager/bsqmods" target="_blank" rel="noopener noreferrer" style="text-decoration:none;">
      <button class="header-btn">
        <svg viewBox="0 0 16 16" width="16" height="16" fill="currentColor"><path d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2.0-.21.15-.46.55-.38C13.71 14.53 16 11.54 16 8c0-4.42-3.58-8-8-8z"/></svg>
        Mod data from BSQMods
      </button>
    </a>
  </div>
</header>

<main>
  <div class="top-controls">
    <div class="search-container">
      <input id="searchInput" placeholder="Search your selected mods..." autocomplete="off">
    </div>

    <div class="version-select-container">
      <div class="custom-select-wrapper" id="versionDropdown">
        <div class="dropdown-trigger" id="trigger">
          <span id="triggerText">Select Versions (Max 5)</span>
          <div class="arrow"></div>
        </div>
        <div class="custom-options" id="optionsList"></div>
      </div>
    </div>

    <button id="deselectBtn" class="action-btn">Deselect Versions</button>
    <a href="/" style="text-decoration:none;"><button class="action-btn">Select Mods</button></a>
  </div>

  <div class="table-wrapper">
    <table class="compat-grid" id="compatGrid">
      <thead id="compatHead"></thead>
      <tbody id="compatBody"></tbody>
    </table>
  </div>
</main>

<script>
// Main initialization for the compatibility checker
async function initApp() {
  // 1. Fetch the mod data index
  const res = await fetch("mods/index.json");
  const data = await res.json();

  // 2. Load the user's mod selection from localStorage
  let selectedIDs = JSON.parse(localStorage.getItem("selectedMods") || "{}");

  // 3. Collect unique Beat Saber versions and map mods to those versions
  const modMap = new Map();
  const versionsSet = new Set();

  Object.entries(data).forEach(([ver, mods]) => {
    versionsSet.add(ver);
    mods.forEach(m => {
      if (!modMap.has(m.id)) {
        modMap.set(m.id, { ...m, supportedVersions: [ver] });
      } else {
        modMap.get(m.id).supportedVersions.push(ver);
      }
    });
  });

  // 4. Filter only the mods the user selected on the main page
  const myMods = [...modMap.values()]
    .filter(m => selectedIDs[m.id])
    .sort((a,b) => a.name.localeCompare(b.name));

  // 5. Sort available versions numerically (highest first)
  const allVersions = [...versionsSet].sort((a,b) => b.localeCompare(a, undefined, { numeric: true }));

  let selectedVersions = [];
  const MAX_VERSIONS = 5;

  // --- Dropdown Logic ---
  const dropdown = document.getElementById("versionDropdown");
  const trigger = document.getElementById("trigger");
  const triggerText = document.getElementById("triggerText");
  const optionsList = document.getElementById("optionsList");

  // Populate the custom dropdown with versions
  allVersions.forEach(ver => {
    const opt = document.createElement("div");
    opt.className = "custom-option";
    opt.innerHTML = `<span>${ver}</span><span class="check"></span>`;
    opt.onclick = (e) => {
      e.stopPropagation();
      toggleVersion(ver, opt);
    };
    optionsList.appendChild(opt);
  });

  // Handle dropdown open/close
  trigger.onclick = () => {
    dropdown.classList.toggle("open");
    trigger.classList.toggle("active");
  };

  window.onclick = (e) => {
    if (!dropdown.contains(e.target)) {
      dropdown.classList.remove("open");
      trigger.classList.remove("active");
    }
  };

  // Add or remove a version from the selection
  function toggleVersion(ver, element) {
    const idx = selectedVersions.indexOf(ver);
    if (idx > -1) {
      selectedVersions.splice(idx, 1);
      element.classList.remove("selected");
      element.querySelector(".check").textContent = "";
    } else {
      if (selectedVersions.length >= MAX_VERSIONS) return;
      selectedVersions.push(ver);
      selectedVersions.sort((a,b) => b.localeCompare(a, undefined, { numeric: true }));
      element.classList.add("selected");
      element.querySelector(".check").textContent = "✔";
    }
    updateTriggerText();
    updateOptionsState();
    renderGrid();
  }

  function updateTriggerText() {
    triggerText.textContent = selectedVersions.length === 0 ? "Select Versions (Max 5)" : selectedVersions.join(", ");
    triggerText.style.color = selectedVersions.length === 0 ? "#aaa" : "#fff";
  }

  function updateOptionsState() {
    const isFull = selectedVersions.length >= MAX_VERSIONS;
    optionsList.querySelectorAll(".custom-option").forEach(opt => {
      const isSelected = opt.classList.contains("selected");
      opt.classList.toggle("disabled", !isSelected && isFull);
    });
  }

  // --- Reset Functionality ---
  document.getElementById("deselectBtn").onclick = () => {
    selectedVersions = [];
    optionsList.querySelectorAll(".custom-option").forEach(opt => {
      opt.classList.remove("selected", "disabled");
      opt.querySelector(".check").textContent = "";
    });
    updateTriggerText();
    renderGrid();
  };

  // --- Table Grid Rendering ---
  const searchInput = document.getElementById("searchInput");
  const head = document.getElementById("compatHead");
  const body = document.getElementById("compatBody");

  function renderGrid() {
    const term = searchInput.value.toLowerCase();

    // Show empty state if no mods selected from main page
    if (myMods.length === 0) {
      head.innerHTML = "<tr><th>Status</th></tr>";
      body.innerHTML = `<tr><td style="text-align:center; padding:3rem; color:#888;">No mods selected. <br><a href="index.html" style="color:#667eea">Go back to Select Mods</a></td></tr>`;
      return;
    }

    // Prompt user to pick a version
    if (selectedVersions.length === 0) {
      head.innerHTML = "<tr><th>Mod Name</th><th>Status</th></tr>";
      body.innerHTML = `<tr><td colspan="2" style="text-align:center; padding:3rem; color:#888;">Pick a Beat Saber version from the dropdown above.</td></tr>`;
      return;
    }

    // Build Table Header
    head.innerHTML = `<tr><th>Mod Details</th>${selectedVersions.map(v => `<th>${v}</th>`).join("")}</tr>`;

    // Filter by search
    const filtered = myMods.filter(m => m.name.toLowerCase().includes(term) || (m.author && m.author.toLowerCase().includes(term)));
    body.innerHTML = "";

    // Build Table Rows
    filtered.forEach(mod => {
      const row = document.createElement("tr");
      const cells = selectedVersions.map(v => {
        const isCompat = mod.supportedVersions.includes(v);
        return `<td class="status-cell ${isCompat ? 'compatible' : 'incompatible'}">${isCompat ? '✔' : '✖'}</td>`;
      }).join("");

      row.innerHTML = `
        <td>
          <div style="font-weight:600;color:#fff">${mod.name}</div>
          <div style="font-size:0.8rem;color:#888">by ${mod.author || 'Unknown'}</div>
        </td>
        ${cells}
      `;
      body.appendChild(row);
    });
  }

  searchInput.oninput = renderGrid;
  renderGrid();
}

initApp();
</script>
</body>
</html>